<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Personalized Story Typing Adventure</title>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
}
    </style>
</head>
<body class="bg-gradient-to-r from-blue-100 to-blue-200 min-h-screen flex items-center justify-center p-4">
    <div
        x-data="storyTypingGame()"
        x-init="initializeStories()"
        class="container mx-auto max-w-4xl bg-white rounded-xl shadow-lg p-6"
    >
        <!-- Registration Screen -->
        <template x-if="gameState === 'registration'">
            <div class="text-center">
                <h1 class="text-4xl font-bold mb-8 text-blue-600">Story Typer Challenge</h1>
                <form @submit.prevent="startGame" class="space-y-6 max-w-md mx-auto">
                    <input
                        x-model="playerName"
                        type="text"
                        placeholder="Your Name"
                        required
                        class="w-full p-4 border-2 border-blue-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                    <div class="space-y-2">
                        <p class="text-gray-700">Select Gender:</p>
                        <div class="flex justify-center space-x-6">
                            <label class="flex items-center space-x-2">
                                <input
                                    type="radio"
                                    x-model="playerGender"
                                    value="male"
                                    required
                                    class="form-radio text-blue-500"
                                >
                                <span>Boy</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input
                                    type="radio"
                                    x-model="playerGender"
                                    value="female"
                                    required
                                    class="form-radio text-blue-500"
                                >
                                <span>Girl</span>
                            </label>
                        </div>
                    </div>
                    <button
                        type="submit"
                        class="w-full bg-blue-500 text-white p-4 rounded-lg hover:bg-blue-600 transition duration-300"
                    >
                        Start Typing Adventure
                    </button>
                </form>
            </div>
        </template>

        <!-- Game Screen -->
        <template x-if="gameState === 'playing'">
            <div>
                <!-- Game Header -->
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 x-text="currentStory.title" class="text-2xl font-bold text-blue-700"></h2>
                        <p class="text-sm text-gray-600">
                            Level <span x-text="currentLevel"></span> / 5
                        </p>
                    </div>
                    <div class="text-right">
                        <p>Score: <span x-text="score"></span></p>
                        <p>Time Left: <span x-text="timeLeft"></span>s</p>
                        <button
                            @click="logout"
                            class="mt-2 text-sm text-red-600 hover:text-red-800"
                        >
                            Logout
                        </button>
                    </div>
                </div>

                <!-- Story Display -->
                <div class="mb-6 p-4 bg-blue-50 rounded-lg h-96 overflow-auto">
                    <div class="text-center space-y-4">
                        <template x-for="(line, lineIndex) in currentStoryText.split('\n')" :key="lineIndex">
                            <p class="text-2xl leading-relaxed">
                                <template x-for="(char, charIndex) in line" :key="charIndex">
                                    <span
                                        :class="{
                                            'text-green-600': lineIndex * line.length + charIndex < characterIndex,
                                            'text-3xl font-bold bg-blue-100 rounded px-1': lineIndex * line.length + charIndex === characterIndex,
                                            'text-red-500': lineIndex * line.length + charIndex < characterIndex && userInput[lineIndex * line.length + charIndex] !== currentStoryText[lineIndex * line.length + charIndex],
                                            'text-gray-400': lineIndex * line.length + charIndex > characterIndex
                                        }"
                                        x-text="char"
                                    ></span>
                                </template>
                            </p>
                        </template>
                    </div>
                </div>

                <!-- Typing Area (Hidden Input) -->
                <input
                    x-model="userInput"
                    @input="checkInput"
                    @keydown.space.prevent="handleSpace"
                    type="text"
                    class="absolute opacity-0"
                    autofocus
                >

                <!-- Progress Bar -->
                <div class="mt-4">
                    <div class="bg-blue-200 h-2 rounded-full overflow-hidden">
                        <div
                            :style="`width: ${progress}%`"
                            class="bg-blue-500 h-full transition-all duration-300"
                        ></div>
                    </div>
                </div>
            </div>
        </template>

        <!-- Game Over Screen -->
        <template x-if="gameState === 'gameOver'">
            <div class="text-center">
                <h2 class="text-4xl font-bold mb-6 text-blue-700">
                    <span x-text="completedSuccessfully ? 'Congratulations!' : 'Game Over'"></span>
                </h2>
                <div class="bg-blue-50 p-6 rounded-lg max-w-md mx-auto">
                    <p class="text-xl mb-4">
                        Final Score: <span x-text="score" class="font-bold text-blue-600"></span>
                    </p>
                    <p class="text-lg mb-4" x-show="!completedSuccessfully">
                        You ran out of time. Keep practicing!
                    </p>
                    <div class="space-y-3">
                        <button
                            @click="playAgain"
                            class="w-full bg-green-500 text-white p-4 rounded-lg hover:bg-green-600 transition duration-300"
                        >
                            Play Another Story
                        </button>
                        <button
                            @click="logout"
                            class="w-full bg-red-500 text-white p-4 rounded-lg hover:bg-red-600 transition duration-300"
                        >
                            Logout
                        </button>
                    </div>
                </div>
            </div>
        </template>
    </div>

    <script>
        function storyTypingGame() {
            return {
                // Game State
                gameState: 'registration',
                playerName: '',
                playerGender: '',
                stories: [],
                usedStoryIds: new Set(), // Track used stories
                // Story Management
                currentStory: null,
                currentStoryText: '',
                currentLevel: 1,
                // Typing Mechanics
                userInput: '',
                characterIndex: 0,
                currentWordIndex: 0,
                hasMistake: false,
                score: 0,
                progress: 0,
                timeLeft: 600, // 10 minutes total
                timer: null,
                // Game Outcomes
                completedSuccessfully: false,
                // Initialize Stories
                async initializeStories() {
                    try {
                        const response = await fetch('stories.json');
                        const data = await response.json();
                        this.stories = data.stories;
                        
                        // Check for saved game state
                        const savedState = localStorage.getItem('gameState');
                        if (savedState) {
                            const state = JSON.parse(savedState);
                            this.playerName = state.playerName;
                            this.playerGender = state.playerGender;
                            this.usedStoryIds = new Set(state.usedStoryIds);
                            this.gameState = 'playing';
                            this.startGame();
                        }
                    } catch (error) {
                        console.error('Error loading stories:', error);
                        alert('Failed to load stories. Please refresh the page.');
                    }
                },
                // Name Replacement Method
                replaceNameInStory(story, playerName) {
                    const namePlaceholders = [
                        '{{NAME}}',
                        '[NAME]',
                        '{PLAYER_NAME}',
                        'PROTAGONIST_NAME'
                    ];

                    let modifiedStory = story.text;

                    namePlaceholders.forEach(placeholder => {
                        modifiedStory = modifiedStory.split(placeholder).join(playerName);
                    });

                    return {
                        ...story,
                        text: modifiedStory
                    };
                },
                // Validate and Prepare Name
                validateName(name) {
                    let cleanedName = name.trim();
                    cleanedName = cleanedName.charAt(0).toUpperCase() + cleanedName.slice(1);
                    cleanedName = cleanedName.replace(/[^a-zA-Z\s]/g, '');
                    return cleanedName || 'Player';
                },
                // Start Game Method
                startGame() {
                    if (!this.playerName || !this.playerGender) {
                        alert('Please fill in all details');
                        return;
                    }
                    // Validate name
                    this.playerName = this.validateName(this.playerName);

                    // Filter stories by player's gender and exclude used stories
                    const availableStories = this.stories.filter(story => {
                        const storyGender = story.gender === 'boy' ? 'male' : 
                                          story.gender === 'girl' ? 'female' : 
                                          story.gender;
                        return storyGender === this.playerGender && !this.usedStoryIds.has(story.id);
                    });

                    // If no new stories available for the selected gender, reset used stories
                    if (availableStories.length === 0) {
                        this.usedStoryIds.clear();
                        return this.startGame(); // Retry with reset used stories
                    }

                    // Select a random story
                    let selectedStory = availableStories[Math.floor(Math.random() * availableStories.length)];
                    this.usedStoryIds.add(selectedStory.id);

                    // Replace name in the story
                    this.currentStory = this.replaceNameInStory(selectedStory, this.playerName);
                    this.currentStoryText = this.currentStory.text;
                    this.gameState = 'playing';
                    this.startTimer();

                    // Save game state
                    this.saveGameState();
                },
                // Save Game State
                saveGameState() {
                    const state = {
                        playerName: this.playerName,
                        playerGender: this.playerGender,
                        usedStoryIds: Array.from(this.usedStoryIds)
                    };
                    localStorage.setItem('gameState', JSON.stringify(state));
                },
                // Play Again Method
                playAgain() {
                    this.userInput = '';
                    this.characterIndex = 0;
                    this.currentWordIndex = 0;
                    this.hasMistake = false;
                    this.score = 0;
                    this.progress = 0;
                    this.timeLeft = 600;
                    this.currentLevel = 1;
                    this.completedSuccessfully = false;
                    this.startGame();
                },
                // Logout Method
                logout() {
                    clearInterval(this.timer);
                    localStorage.removeItem('gameState');
                    this.resetGame();
                },
                // Timer Management
                startTimer() {
                    this.timer = setInterval(() => {
                        this.timeLeft--;

                        // Level progression
                        const totalLength = this.currentStoryText.length;
                        const levelLength = Math.floor(totalLength / 5);
                        const currentLevelProgress = Math.floor(this.characterIndex / levelLength) + 1;

                        this.currentLevel = Math.min(currentLevelProgress, 5);
                        this.progress = (this.characterIndex / totalLength) * 100;

                        // Game over conditions
                        if (this.timeLeft <= 0 || this.characterIndex >= this.currentStoryText.length) {
                            this.endGame();
                        }
                    }, 1000);
                },
                // Input Checking
                checkInput() {
                    // Check if user input matches the next characters
                    if (this.userInput === this.currentStoryText.slice(0, this.userInput.length)) {
                        this.characterIndex = this.userInput.length;
                        this.score = this.characterIndex;
                    } else {
                        // Don't remove the last character, just mark it as incorrect
                        this.characterIndex = this.userInput.length;
                        this.score = this.characterIndex;
                    }
                },
                // Handle Space Key
                handleSpace(event) {
                    event.preventDefault();
                    const nextChar = this.currentStoryText[this.characterIndex];
                    if (nextChar === ' ') {
                        this.userInput += ' ';
                        this.characterIndex++;
                        this.score = this.characterIndex;
                    }
                },
                // End Game Method
                endGame() {
                    clearInterval(this.timer);
                    this.gameState = 'gameOver';
                    this.completedSuccessfully = this.characterIndex >= this.currentStoryText.length;

                    // Save game history
                    const gameHistory = JSON.parse(localStorage.getItem('storyTyperHistory') || '[]');
                    gameHistory.push({
                        name: this.playerName,
                        gender: this.playerGender,
                        story: this.currentStory.title,
                        score: this.score,
                        completed: this.completedSuccessfully,
                        date: new Date().toISOString()
                    });
                    localStorage.setItem('storyTyperHistory', JSON.stringify(gameHistory));
                },
                // Reset Game
                resetGame() {
                    this.gameState = 'registration';
                    this.userInput = '';
                    this.characterIndex = 0;
                    this.currentWordIndex = 0;
                    this.hasMistake = false;
                    this.score = 0;
                    this.progress = 0;
                    this.timeLeft = 600;
                    this.currentLevel = 1;
                    this.completedSuccessfully = false;
                    this.usedStoryIds.clear();
                }
            }
        }
    </script>
</body>
</html>
